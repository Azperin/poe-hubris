<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Cache-Control" content="no-cache" />
<meta name="viewport" content="width=device-width,initial-scale=1.0">

<title>Poe Hubris</title>
<style>
	* {
		color: white;
		margin: 0px;
		padding: 0px;
		box-sizing: border-box;
		z-index: 2;
	}
	img {
		width: 400px;
		height: 400px;
	}
	body {
		background-color: black;
		min-height: 100vh;
		min-width: 100vm;
		display: flex;
		justify-content: center;
		background-position: center top;
		background-size: contain;
		background-repeat: no-repeat;
	}
	input.filter-skill {
		width: 50px;
		margin-right: 5px;
		color: black;
	}
	.result {
		max-width: 350px;
		min-width: 350px;
		margin: 0 30px;
		padding-top: 20px;
		background-color: black;
		max-height: 90px;
	}
	
	.result input[type="button"] {
		color: black;
		border-radius: 0;
		padding: 10px;
	}
	body > div {
		max-width: 350px;
		min-width: 350px;
		border: 1px solid black;
		padding: 4px;
	}
	.filter-filler {
		position: absolute;
		min-width: 100%;
		min-height: 100%;
		background-color: black;
	}
	
	 #filter_seed {
		color: black;
	 }
	 
	 #socket-link {
		padding: 3px;
		width: 70px;
	 }
	 
	 .clear-btn {
		color: black;
		width: 20px;
		margin-right: 4px;
	 }
	 
	 
}
</style>
</head>
<body>
<div class="filter-filler"></div>
<div class="filter-skills-container">
	<div>
		<input id="filter_seed" type="text" placeholder="coins number" />
	</div>
	<hr>
	<div>
		<input id="filter_divined" type="checkbox" checked />
		<label for="filter_divined">HIDE DIVINED</label>
	</div>
	
	<div>
		<button class="clear-btn" onclick="clearInput(8)">X</button><input id="filter_skill_8" data-val="40" data-skillidx="8" type="number" class="filter-skill" /><label for="filter_skill_8">Rarity of Items found</label>
	</div>
	<div>
		<button class="clear-btn" onclick="clearInput(19)">X</button><input id="filter_skill_19" data-val="20" data-skillidx="19" type="number" class="filter-skill" /><label for="filter_skill_19">Flask Effect Duration</label>
	</div>
	<div>
		<button class="clear-btn" onclick="clearInput(40)">X</button><input id="filter_skill_40" data-val="12" data-skillidx="40" type="number" class="filter-skill" /><label for="filter_skill_40">Auras Effect</label>
	</div>
	<div>
		<button class="clear-btn" onclick="clearInput(28)">X</button><input id="filter_skill_28" data-val="30" data-skillidx="28" type="number" class="filter-skill" /><label for="filter_skill_28">Maximum Mana</label>
	</div>
	<div>
		<button class="clear-btn" onclick="clearInput(33)">X</button><input id="filter_skill_33" data-val="10" data-skillidx="33" type="number" class="filter-skill" /><label for="filter_skill_33">Maximum Life</label>
	</div>
	<div>
		<button class="clear-btn" onclick="clearInput(38)">X</button><input id="filter_skill_38" data-val="80" data-skillidx="38" type="number" class="filter-skill" /><label for="filter_skill_38">Minions Damage</label>
	</div>
	<div>
		<button class="clear-btn" onclick="clearInput(0)">X</button><input id="filter_skill_0" data-val="80" data-skillidx="0" type="number" class="filter-skill" /><label for="filter_skill_0">Minions Life</label>
	</div>
	<div>
		<button class="clear-btn" onclick="clearInput(7)">X</button><input id="filter_skill_7" data-val="15" data-skillidx="7" type="number" class="filter-skill" /><label for="filter_skill_7">Cast Speed</label>
	</div>
	<div>
		<button class="clear-btn" onclick="clearInput(42)">X</button><input id="filter_skill_42" data-val="15" data-skillidx="42" type="number" class="filter-skill" /><label for="filter_skill_42">Attack Speed</label>
	</div>
	<div>
		<button class="clear-btn" onclick="clearInput(18)">X</button><input id="filter_skill_18" data-val="80" data-skillidx="18" type="number" class="filter-skill" /><label for="filter_skill_18">Critical Strike Chance</label>
	</div>
	<div>
		<button class="clear-btn" onclick="clearInput(20)">X</button><input id="filter_skill_20" data-val="80" data-skillidx="20" type="number" class="filter-skill" /><label for="filter_skill_20">Critical Strike Chance for Spells</label>
	</div>
	<div>
		<button class="clear-btn" onclick="clearInput(3)">X</button><input id="filter_skill_3" data-val="40" data-skillidx="3" type="number" class="filter-skill" /><label for="filter_skill_3">Critical Strike Multiplier</label>
	</div>
	<div>
		<button class="clear-btn" onclick="clearInput(21)">X</button><input id="filter_skill_21" data-val="80" data-skillidx="21" type="number" class="filter-skill" /><label for="filter_skill_21">Spell Damage</label>
	</div>
	<div>
		<button class="clear-btn" onclick="clearInput(22)">X</button><input id="filter_skill_22" data-val="80" data-skillidx="22" type="number" class="filter-skill" /><label for="filter_skill_22">Physical Damage</label>
	</div>
	<div>
		<button class="clear-btn" onclick="clearInput(30)">X</button><input id="filter_skill_30" data-val="80" data-skillidx="30" type="number" class="filter-skill" /><label for="filter_skill_30">Melee Physical Damage</label>
	</div>
	<div>
		<button class="clear-btn" onclick="clearInput(26)">X</button><input id="filter_skill_26" data-val="80" data-skillidx="26" type="number" class="filter-skill" /><label for="filter_skill_26">Projectile Attack Damage</label>
	</div>
	<div>
		<button class="clear-btn" onclick="clearInput(4)">X</button><input id="filter_skill_4" data-val="80" data-skillidx="4" type="number" class="filter-skill" /><label for="filter_skill_4">Lightning Damage with Attack Skills</label>
	</div>
	<div>
		<button class="clear-btn" onclick="clearInput(2)">X</button><input id="filter_skill_2" data-val="80" data-skillidx="2" type="number" class="filter-skill" /><label for="filter_skill_2">Cold Damage with Attack Skills</label>
	</div>
	<div>
		<button class="clear-btn" onclick="clearInput(27)">X</button><input id="filter_skill_27" data-val="80" data-skillidx="27" type="number" class="filter-skill" /><label for="filter_skill_27">Fire Damage with Attack Skills</label>
	</div>
	<div>
		<button class="clear-btn" onclick="clearInput(10)">X</button><input id="filter_skill_10" data-val="10" data-skillidx="10" type="number" class="filter-skill" /><label for="filter_skill_10">Damage per Frenzy Charge</label>
	</div>
	<div>
		<button class="clear-btn" onclick="clearInput(12)">X</button><input id="filter_skill_12" data-val="10" data-skillidx="12" type="number" class="filter-skill" /><label for="filter_skill_12">Damage per Power Charge</label>
	</div>
	<div>
		<button class="clear-btn" onclick="clearInput(11)">X</button><input id="filter_skill_11" data-val="10" data-skillidx="11" type="number" class="filter-skill" /><label for="filter_skill_11">Damage per Endurance Charge</label>
	</div>
	<div>
		<button class="clear-btn" onclick="clearInput(44)">X</button><input id="filter_skill_44" data-val="37" data-skillidx="44" type="number" class="filter-skill" /><label for="filter_skill_44">Chaos Resistance</label>
	</div>
</div>
<div class="result">
	<div style="display: flex; justify-content: space-between;">
		<input type="button" value="PREV" onClick="showSocket('prev')" />
		<input type="button" value="FILTERS" onClick="toggleFilters()" />
		<input type="button" value="NEXT" onClick="showSocket('next')"/>
	</div>
	<div id="corusel-counter" style="text-align: center;">0</div>
	<div style="text-align: center;"><input id="socket-link" type="button" onclick="copyLink()" value="copy link" /></div>
	<div style="text-align: center;" id="sell-info"></div>
</div>
<div class="filter-sockets-container">
	<div>
		LJS - Large Jewel Socket
		<hr>
	</div>
	<div>
		<input data-fsocketid="0" class="filter-socket" id="filter_socket_1" type="checkbox" checked />
		<label for="filter_socket_1">Witch TOP RIGHT LJS</label>
	</div>
	<div>
		<input data-fsocketid="1" class="filter-socket" id="filter_socket_2" type="checkbox" checked />
		<label for="filter_socket_2">Witch TOP LEFT LJS</label>
	</div>
	<div>
		<input data-fsocketid="2" class="filter-socket" id="filter_socket_3" type="checkbox" checked />
		<label for="filter_socket_3">Witch TOP CENTER</label>
	</div>
	<div>
		<input data-fsocketid="3" class="filter-socket" id="filter_socket_4" type="checkbox" checked />
		<label for="filter_socket_4">Witch BOT LEFT</label>
	</div>
	<div>
		<input data-fsocketid="4" class="filter-socket" id="filter_socket_5" type="checkbox" checked />
		<label for="filter_socket_5">Witch BOT RIGHT</label>
	</div>
	<div>
		<input data-fsocketid="5" class="filter-socket" id="filter_socket_6" type="checkbox" checked />
		<label for="filter_socket_6">Shadow TOP RIGHT</label>
	</div>
	<div>
		<input data-fsocketid="6" class="filter-socket" id="filter_socket_7" type="checkbox" checked />
		<label for="filter_socket_7">Shadow CENTER LEFT</label>
	</div>
	<div>
		<input data-fsocketid="7" class="filter-socket" id="filter_socket_8" type="checkbox" checked />
		<label for="filter_socket_8">Shadow CENTER RIGHT LJS</label>
	</div>
	<div>
		<input data-fsocketid="8" class="filter-socket" id="filter_socket_9" type="checkbox" checked />
		<label for="filter_socket_9">Shadow BOT RIGHT</label>
	</div>
	<div>
		<input data-fsocketid="9" class="filter-socket" id="filter_socket_10" type="checkbox" checked />
		<label for="filter_socket_10">Duelist TOP RIGHT</label>
	</div>
	<div>
		<input data-fsocketid="10" class="filter-socket" id="filter_socket_11" type="checkbox" checked />
		<label for="filter_socket_11">Duelist BOT RIGHT LJS</label>
	</div>
	<div>
		<input data-fsocketid="11" class="filter-socket" id="filter_socket_12" type="checkbox" checked />
		<label for="filter_socket_12">Duelist BOT CENTER</label>
	</div>
	<div>
		<input data-fsocketid="12" class="filter-socket" id="filter_socket_13" type="checkbox" checked />
		<label for="filter_socket_13">Duelist BOT LEFT LJS</label>
	</div>
	<div>
		<input data-fsocketid="13" class="filter-socket" id="filter_socket_14" type="checkbox" checked />
		<label for="filter_socket_14">Duelist TOP LEFT</label>
	</div>
	<div>
		<input data-fsocketid="14" class="filter-socket" id="filter_socket_15" type="checkbox" checked />
		<label for="filter_socket_15">Templar BOT LEFT</label>
	</div>
	<div>
		<input data-fsocketid="15" class="filter-socket" id="filter_socket_16" type="checkbox" checked />
		<label for="filter_socket_16">Templar CENTER LEFT LJS</label>
	</div>
	<div>
		<input data-fsocketid="16" class="filter-socket" id="filter_socket_17" type="checkbox" checked />
		<label for="filter_socket_17">Templar CENTER RIGHT</label>
	</div>
	<div>
		<input data-fsocketid="17" class="filter-socket" id="filter_socket_18" type="checkbox" checked />
		<label for="filter_socket_18">Templar TOP RIGHT</label>
	</div>
	<div>
		<input data-fsocketid="18" class="filter-socket" id="filter_socket_19" type="checkbox" checked />
		<label for="filter_socket_19">Scion LEFT</label>
	</div>
	<div>
		<input data-fsocketid="19" class="filter-socket" id="filter_socket_20" type="checkbox" checked />
		<label for="filter_socket_20">Scion RIGHT</label>
	</div>
	<div>
		<input data-fsocketid="20" class="filter-socket" id="filter_socket_21" type="checkbox" checked />
		<label for="filter_socket_21">Scion CENTER</label>
	</div>
</div>

</body>
<script src="jewelsDB.js"></script>
<script src="sellInfo.js"></script>
<script>
	// test automation
	divinedJewels = [...new Set(divinedJewels)];
	let resultElement = document.querySelector('.result');
	let seedInputElement = document.getElementById('filter_seed');
	let couruselCounter = document.getElementById('corusel-counter');
	let filterSocketsNodes = document.querySelectorAll('.filter-socket');
	let filterSkillsNodes = document.querySelectorAll('.filter-skill');
	let filterDivined = document.getElementById('filter_divined');
	let sellInfoEl = document.getElementById('sell-info');
	let result = [];
	let currentResultIndex = -1;
	
	document.querySelector('#socket-link').style.display = 'none';
	sellInfoEl.style.display = 'none';
	
	hashCheck();
	function hashCheck() {
		if (!window.location.hash) return;
		let [ seed, ...sockets] = window.location.hash.split('_');
		seed = seed.replaceAll(/[^0-9]/g, '');
		seedInputElement.value = seed;
		if (sockets && sockets.length === 1) {
			filterSocketsNodes.forEach((e, i) => {
				e.checked = false;
			});
			sockets[0].split('.').splice(0, 21).map(x => parseInt(x,10)).filter(x => Number.isInteger(x) && x >= 0 && x < 21).forEach((x, i) => {
				filterSocketsNodes[parseInt(x, 10)].checked = true;
			});
		};
		toggleFilters();
	};
	
	function clearInput(e) {
		document.querySelector(`#filter_skill_${e}`).value = '';
		search();
	};
	
	function search() {
		let socketsToCheck = [];
		let skillsToCheck = [];
		result = [];
		
		filterSocketsNodes.forEach(x => {
			if (x.checked) {
				socketsToCheck.push(parseInt(x.dataset.fsocketid, 10));
			};
		});
		if (socketsToCheck.length === 0) return;
		
		filterSkillsNodes.forEach(x => {
			let v = parseInt(x.value, 10);
			skillsToCheck.push({
				idx: parseInt(x.dataset.skillidx, 10),
				count: (Number.isNaN(v) ? (-1) : v),
			});
		});
		
		skillsToCheck = skillsToCheck.filter(x => x.count > 0);
		
		Object.keys(jewels).forEach(jewelSeed => {
			if (filterDivined.checked && divinedJewels.includes(jewelSeed)) return;
		
			if (seedInputElement.value && jewelSeed !== seedInputElement.value) return;
		
			jewels[jewelSeed].socketSkills.forEach((socket, sockIdx) => {
				if (!socketsToCheck.includes(sockIdx)) return;
				let isPassed = skillsToCheck.every(x => {
					let q = socket.reduce((a, b) => {
						if (b === x.idx) {
							a += 1;
						};
						return a;
					}, 0);
					
					return q >= x.count;
				});
				if (isPassed) {
					result.push({
						seed: jewelSeed,
						socket: sockIdx,
					});
				};
				
			});
		});
		showSocket('next', true);
	};
	
	function toggleFilters() {
		let a = document.querySelector('.filter-skills-container').style.display;
		if (a) {
			document.querySelector('.filter-skills-container').style.display = '';
			document.querySelector('.filter-sockets-container').style.display = '';
			document.querySelector('.filter-filler').style.display = '';
			document.querySelector('#socket-link').style.display = 'none';
			sellInfoEl.style.display = 'none';
			
			
		} else {
			document.querySelector('.filter-skills-container').style.display = 'none';
			document.querySelector('.filter-sockets-container').style.display = 'none';
			document.querySelector('.filter-filler').style.display = 'none';
			document.querySelector('#socket-link').style.display = '';
			sellInfoEl.style.display = '';
		};		
	};
	
	function showSocket(e,b) {
		if (result.length === 0) {
			currentResultIndex = -1;
			document.body.style.backgroundImage = '';
			couruselCounter.innerHTML = `0`;
			return;
		};
		let nextIndex;
		if (b) {
			nextIndex = 0;
		} else if (e === 'next') {
			nextIndex = currentResultIndex + 1;
			if (!result[nextIndex]) {
				nextIndex = 0;
			};
		} else {
			nextIndex = currentResultIndex - 1;
			if (!result[nextIndex]) {
				nextIndex = result.length - 1;
			};
		};
		currentResultIndex = nextIndex;
		couruselCounter.innerHTML = `${(nextIndex + 1)} of ${result.length}`;
		document.body.style.backgroundImage = `url(${jewels[result[nextIndex].seed].socketImgs[result[nextIndex].socket]})`;
		
		if (divinedJewels.includes(result[nextIndex].seed)) {
			sellInfoEl.innerText = `DIVINED`;
		} else if (jewelPrices.hasOwnProperty(result[nextIndex].seed)) {
			let price = jewelPrices[result[nextIndex].seed];
			if (!price) {
				sellInfoEl.innerText = `SOLD`;
			} else {
				sellInfoEl.innerText = `Price: ${price}`;
			};
		} else {
			sellInfoEl.innerText = `Price: not set yet`;
		};
	};
	
	filterSocketsNodes.forEach(x => {
		x.addEventListener('change', () => {
			modifyHash();
			search();
		});
	});
	
	filterDivined.addEventListener('change', () => {
		search();
	});
	
	filterSkillsNodes.forEach(x => {
		x.value = '';
		x.addEventListener('input', search);
	});
	
	seedInputElement.addEventListener('input', () => {
		modifyHash();
		search();
	});
	
	function modifyHash() {
		if (seedInputElement.value) {
			window.location.hash = seedInputElement.value;
			let s = [...filterSocketsNodes].map((x,i) => (x.checked ? `${i}` : '')).filter(x => !!x);
			if (s.length !== 0 && s.length < 15) {
				window.location.hash += '_';
				window.location.hash += s.reduce((a,x) => `${a}.${x}`, '').substring(1);
			};	
		} else {
			window.location.hash = '';
		};
	};
	
	function copyLink() {
		if (currentResultIndex >= 0) {
			window.navigator.clipboard.writeText(`${window.location.origin}${window.location.pathname}#${result[currentResultIndex].seed}_${result[currentResultIndex].socket}`).then(() => {
				let el = document.querySelector('#socket-link');
				el.style.backgroundColor = 'green';
				setTimeout(() => el.style.backgroundColor = '', 300);
			}).catch(() => '');
		};
	};
	
	search();
	
</script>
</html>
